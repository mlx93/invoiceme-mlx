# Backend Agent M2 - Complete Infrastructure & Testing

Complete M2 infrastructure by implementing event listeners (`@TransactionalEventListener(AFTER_COMMIT)`) for InvoiceSentEmailListener (send invoice email with PDF), PaymentRecordedEmailListener (send payment confirmation), InvoiceFullyPaidEmailListener (send completion notification), ActivityFeedListener (log all events to activity_feed table), and DashboardCacheInvalidationListener (invalidate cache on PaymentRecordedEvent), then implement scheduled jobs with `@Scheduled(cron = "0 0 * * *", zone = "America/Chicago")` for RecurringInvoiceScheduledJob (daily at midnight Central Time to generate invoices from templates) and `@Scheduled(cron = "0 0 1 * *", zone = "America/Chicago")` for LateFeeScheduledJob (1st of month at midnight Central Time to apply late fees to overdue invoices). Next, implement JWT authentication with Spring Security (JWT token generation/validation, SecurityConfig with JWT filter chain, RBAC enforcement via @PreAuthorize annotations on controllers, authentication endpoints POST /auth/login and POST /auth/register), implement global exception handler (@ControllerAdvice returning RFC 7807 Problem Details format using Spring's ProblemDetail class), and write integration tests (CustomerPaymentFlowTest for E2E flow, PartialPaymentTest, OverpaymentCreditTest) to validate all business rules and domain events. Test the core Customer → Invoice → Payment flow via Postman/curl first to verify endpoints work, then add event listeners and scheduled jobs, followed by authentication and error handling to prepare for frontend integration.

