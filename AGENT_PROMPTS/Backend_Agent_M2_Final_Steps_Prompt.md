# Backend Agent M2 - Final Steps

Complete M2 by adding RBAC enforcement via @PreAuthorize annotations to all controllers (CustomerController: @PreAuthorize("hasAnyRole('SYSADMIN', 'ACCOUNTANT', 'SALES')") for create/update, @PreAuthorize("hasRole('SYSADMIN')") for delete; InvoiceController: @PreAuthorize("hasAnyRole('SYSADMIN', 'ACCOUNTANT', 'SALES')") for create/update/markAsSent, @PreAuthorize("hasRole('SYSADMIN')") for cancel; PaymentController: @PreAuthorize("hasAnyRole('SYSADMIN', 'ACCOUNTANT') or (hasRole('CUSTOMER') and @paymentService.isOwnInvoice(#command.invoiceId, authentication.name))") for recordPayment), then complete the RecurringInvoiceTemplate aggregate (domain model with behavior methods generateInvoice(), pause(), resume(), complete(), calculateNextDate(), plus RecurringInvoiceTemplateRepository and vertical slices for template CRUD), and implement extended features: Refunds (IssueRefundCommand, IssueRefundHandler that creates negative payment record, updates invoice balance, applies credit if requested, publishes RefundIssuedEvent), Dashboard (GetMetricsQuery/Handler returning DashboardMetricsResponse with revenue MTD, outstanding invoices, overdue invoices, active customers; GetRevenueTrendQuery/Handler; GetInvoiceStatusQuery/Handler; GetAgingReportQuery/Handler), and User Approval workflow (ApproveUserCommand/Handler, RejectUserCommand/Handler, GetPendingUsersQuery/Handler). Test all endpoints via Postman/curl to verify RBAC enforcement, domain events firing, and business rules working correctly before declaring M2 complete.

